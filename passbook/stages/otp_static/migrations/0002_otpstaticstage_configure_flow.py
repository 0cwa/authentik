# Generated by Django 3.1.1 on 2020-09-24 20:51

import django.db.models.deletion
from django.apps.registry import Apps
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor


def create_default_setup_flow(apps: Apps, schema_editor: BaseDatabaseSchemaEditor):
    Flow = apps.get_model("passbook_flows", "Flow")
    FlowStageBinding = apps.get_model("passbook_flows", "FlowStageBinding")

    OTPStaticStage = apps.get_model("passbook_stages_otp_static", "OTPStaticStage")

    db_alias = schema_editor.connection.alias

    flow, _ = Flow.objects.using(db_alias).update_or_create(
        slug="default-otp-static-configure",
        designation=FlowDesignation.STAGE_SETUP,
        defaults={"name": "Setup Static OTP Tokens"},
    )

    stage = OTPStaticStage.objects.using(db_alias).update_or_create(
        name="default-otp-static-configure"
    )

    FlowStageBinding.objects.using(db_alias).update_or_create(
        target=flow, stage=stage, defaults={"order": 0}
    )


class Migration(migrations.Migration):

    dependencies = [
        ("passbook_flows", "0013_auto_20200924_1605"),
        ("passbook_stages_otp_static", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="otpstaticstage",
            name="configure_flow",
            field=models.ForeignKey(
                blank=True,
                help_text="Flow used by an authenticated user to configure this Stage. If empty, user will not be able to configure this stage.",
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to="passbook_flows.flow",
            ),
        ),
        migrations.RunPython(create_default_setup_flow),
    ]
